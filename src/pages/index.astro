---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import ObservationCard from "../components/ObservationCard.astro";
import AvalancheProblemBadge from "../components/AvalancheProblemBadge.astro";
import { weatherQuickGlance } from "../data/weatherStations";
import { sponsors } from "../data/sponsors";

const summaries: CollectionEntry<"summaries">[] = await getCollection("summaries");
const latestSummary = summaries.sort(
  (a: CollectionEntry<"summaries">, b: CollectionEntry<"summaries">) => b.data.date.valueOf() - a.data.date.valueOf()
)[0];
const observations: CollectionEntry<"observations">[] = (await getCollection("observations"))
  .filter((observation: CollectionEntry<"observations">) => observation.data.status === "approved")
  .sort(
    (a: CollectionEntry<"observations">, b: CollectionEntry<"observations">) =>
      b.data.date.valueOf() - a.data.date.valueOf()
  )
  .slice(0, 3);

const homeJsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebPage",
      name: "So Cal Snow Avalanche Center | Current Conditions",
      url: "https://www.socalsnow.org/",
      description: latestSummary.data.excerpt
    },
    {
      "@type": "Article",
      headline: latestSummary.data.title,
      datePublished: latestSummary.data.date.toISOString(),
      author: { "@type": "Person", name: latestSummary.data.author },
      url: `https://www.socalsnow.org/conditions/${latestSummary.slug}`
    }
  ]
};

const subscribed = Astro.url.searchParams.get("subscribed") === "1";

const dangerByRange = latestSummary.data.dangerByRange ?? [];
const cardClassByLevel: Record<string, string> = {
  Low: "danger-card--low",
  Moderate: "danger-card--moderate",
  Considerable: "danger-card--considerable",
  High: "danger-card--high",
  Extreme: "danger-card--extreme"
};
---

<BaseLayout title="So Cal Snow Avalanche Center | Current Conditions">
  <script type="application/ld+json" set:html={JSON.stringify(homeJsonLd)}></script>

  <!-- 1. Danger Dashboard -->
  <section class="danger-dashboard" data-pagefind-filter="type:Home">
    <div class="container">
      <p class="dashboard-eyebrow">Current Conditions</p>
      <h1 class="dashboard-title">{latestSummary.data.title}</h1>
      <p class="dashboard-date">{latestSummary.data.date.toDateString()} &middot; {latestSummary.data.author}</p>

      {dangerByRange.length > 0 && (
        <div class="danger-cards">
          {dangerByRange.map((danger: { range: string; level: string }) => (
            <a
              class:list={["danger-card", cardClassByLevel[danger.level] ?? ""]}
              href={`/observations?range=${encodeURIComponent(danger.range)}`}
            >
              <span class="danger-card-range">{danger.range}</span>
              <span class="danger-card-level">{danger.level}</span>
              <span class="danger-card-bar"></span>
            </a>
          ))}
        </div>
      )}

      {latestSummary.data.problems.length > 0 && (
        <div class="dashboard-problems">
          <span class="dashboard-problems-label">Active Problems</span>
          <div class="pill-row">
            {latestSummary.data.problems.map((problem: string) => <AvalancheProblemBadge name={problem} />)}
          </div>
        </div>
      )}

      <p class="dashboard-excerpt">{latestSummary.data.excerpt}</p>
      <a class="button button-on-dark" href={`/conditions/${latestSummary.slug}`}>Read Full Summary</a>
    </div>
  </section>

  <!-- 2. Recent Observations -->
  <section class="section container">
    <div class="section-header">
      <h2>Recent Observations</h2>
      <a href="/observations">View all</a>
    </div>
    <div class="grid grid-3">
      {observations.map((observation) => (
        <ObservationCard
          slug={observation.slug}
          title={observation.data.title}
          location={observation.data.location}
          mountainRange={observation.data.mountainRange || "Unknown range"}
          date={observation.data.date}
          elevationFt={observation.data.elevationFt || observation.data.elevation || 0}
          author={observation.data.author}
          excerpt={observation.data.excerpt}
          photoUrl={observation.data.photos?.[0]}
        />
      ))}
    </div>
  </section>

  <!-- 3. Weather -->
  <section class="section container">
    <div class="section-header">
      <h2>Weather</h2>
      <a href="/weather">Full details</a>
    </div>
    <div class="weather-grid">
      {weatherQuickGlance.map((entry) => {
        const lead = entry.leadStation;
        if (!lead) return null;
        return (
          <div class="weather-row">
            <strong class="weather-range">{entry.range}</strong>
            <span class="weather-stat">{lead.tempF}Â°F</span>
            <span class="weather-stat">Wind {lead.windMph} mph</span>
            <span class="weather-stat">Precip {lead.precipIn}"</span>
            <a href={`/weather?range=${encodeURIComponent(entry.range)}`}>Details</a>
          </div>
        );
      })}
    </div>
  </section>

  <!-- 4. Stay Connected -->
  <section class="section container">
    <div class="grid grid-3 stay-connected">
      <article class="card">
        <h3>Get Condition Alerts</h3>
        <p>New summary notifications during storm cycles.</p>
        {subscribed ? (
          <p style="color:#15803d;font-weight:500;">Subscribed -- check your email to confirm.</p>
        ) : (
          <form id="newsletter-form" method="post" action="/api/newsletter" class="compact-form">
            <input type="hidden" name="renderedAt" id="newsletter-rendered-at" value="" />
            <input type="hidden" name="referrer" value="homepage" />
            <p hidden><label>Leave blank <input name="website" /></label></p>
            <input required type="email" name="email" placeholder="your@email.com" autocomplete="email" />
            <label class="consent-label">
              <input required type="checkbox" name="consent" value="1" />
              <span>I agree to receive emails.</span>
            </label>
            <button id="newsletter-submit" class="button button-primary" type="submit">Subscribe</button>
          </form>
        )}
        <p class="meta" style="margin-top:0.5rem;"><a href="/rss.xml">Or use RSS</a></p>
      </article>
      <article class="card">
        <h3>Learn About Safety</h3>
        <p>New to backcountry travel? Start with the danger scale, then review conditions before heading out.</p>
        <a class="button button-secondary" href="/learn">Start learning</a>
      </article>
      <article class="card">
        <h3>Support SCSAC</h3>
        <p>Help keep avalanche awareness free for the SoCal backcountry community.</p>
        <a class="button button-primary" href="/donate">Donate</a>
      </article>
    </div>
  </section>

  <script is:inline>
    const renderedAtInput = document.getElementById("newsletter-rendered-at");
    const newsletterForm = document.getElementById("newsletter-form");
    const newsletterSubmit = document.getElementById("newsletter-submit");

    if (renderedAtInput) {
      renderedAtInput.value = String(Date.now());
    }

    newsletterForm?.addEventListener("submit", () => {
      if (!newsletterSubmit) return;
      newsletterSubmit.setAttribute("disabled", "true");
      newsletterSubmit.textContent = "Subscribing...";
    });
  </script>
</BaseLayout>
